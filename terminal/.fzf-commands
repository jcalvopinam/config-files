#!/usr/bin/env bash

#----------------------------------------------------------------------------------
# Some functions were adapted from: https://github.com/junegunn/fzf-git.sh
# MIT License
#----------------------------------------------------------------------------------
if [[ $# -eq 1 ]]; then
  branches() {
    git branch "$@" --sort=-committerdate --sort=-HEAD --format=$'%(HEAD) %(color:yellow)%(refname:short) %(color:green)(%(committerdate:relative))\t%(color:blue)%(subject)%(color:reset)' --color=always | column -ts$'\t'
  }
  bswitch() {
    git branch | grep -v '/HEAD\s' | grep -v "*" | awk -F' ' {'print $1'}
  }
  case "$1" in
    branches)
      echo $'ESC (exit) ╱ ALT-A (show all branches)\n'
      branches
      ;;
    bswitch)
      echo $'ENTER (switch) ╱ ESC (exit) ╱ ALT-A (show all branches)\n'
      bswitch
      ;;
    all-branches)
      echo $'ESC (exit)\n'
      branches -a
      ;;
    nobeep) ;;
    *) exit 1 ;;
  esac
elif [[ $# -gt 1 ]]; then
  set -e

  branch=$(git rev-parse --abbrev-ref HEAD 2> /dev/null)
  if [[ $branch = HEAD ]]; then
    branch=$(git describe --exact-match --tags 2> /dev/null || git rev-parse --short HEAD)
  fi

  exit 0
fi

__fzf_git=${BASH_SOURCE[0]:-${(%):-%x}}
__fzf_git=$(readlink -f "$__fzf_git" 2> /dev/null || /usr/bin/ruby --disable-gems -e 'puts File.expand_path(ARGV.first)' "$__fzf_git" 2> /dev/null)


#----------------------------------------------------------------------------------
# Internal functions
#----------------------------------------------------------------------------------
_git_fzf() {
  fzf-tmux -p80%,60% -- \
    --layout=reverse --multi --height=50% --min-height=20 --border \
    --color='header:italic:underline' \
    --preview-window='right,50%,border-left' \
    --bind='ctrl-/:change-preview-window(down,50%,border-top|hidden|)' "$@"
}

_git_check() {
  git rev-parse HEAD > /dev/null 2>&1 && return

  [[ -n $TMUX ]] && tmux display-message "Not in a git repository"
  return 1
}


#----------------------------------------------------------------------------------
# Shows git diff
#----------------------------------------------------------------------------------
function gdiff() {
  if ! git ls-files >& /dev/null; then
    echo $'Git project not found\n'
    return ;
  fi
  git diff $@ --name-only | \
  fzf -m -e --ansi \
    --prompt ' Search files: ' \
    --header $'ESC (exit) ╱ ENTER (open in editor)\n\n' \
    --preview-window right:70%,wrap \
    --layout reverse \
    --border \
    --preview "git diff $@  --abbrev --color=always  -- {-1}" | xargs nvim -p
}


#----------------------------------------------------------------------------------
# Shows git log
#----------------------------------------------------------------------------------
function glogg() {
  if ! git ls-files >& /dev/null; then
    echo $'Git project not found\n'
    return ;
  fi
  git log --abbrev --oneline --decorate --color --abbrev-commit \
  --pretty=format:"%Cred%h%Creset -%C(yellow)%d%Creset %s %C(bold blue)(%an)%Creset" | sed 's/Merged in //' $@ | \
  fzf -m -e --ansi \
    --prompt ' Search (hash/message/author): ' \
    --header $'ESC (exit)\n\n' \
    --preview-window right:70%,wrap \
    --tiebreak begin \
    --color hl:underline,hl+:underline \
    --layout reverse \
    --border \
    --preview "git show {1} --color=always --abbrev --show-signature " | awk -F' ' {'print $1'} | pbcopy
}


#----------------------------------------------------------------------------------
# Shows git branches
#----------------------------------------------------------------------------------
function gbranch() {
  if ! git ls-files >& /dev/null; then
    echo $'Git project not found\n'
    return ;
  fi
  _git_check || return
  bash "$__fzf_git" branches |
  fzf -m -e --ansi \
    --prompt ' Search branch: ' \
    --header-lines 2 \
    --preview-window down,border-top,75% \
    --tiebreak begin \
    --color hl:underline,hl+:underline \
    --layout reverse \
    --border \
    --bind 'ctrl-/:change-preview-window(down,70%|hidden|)' \
    --bind "ctrl-o:execute-silent:bash $__fzf_git branch {}" \
    --bind "alt-a:change-prompt( All branches> )+reload:bash \"$__fzf_git\" all-branches" \
    --preview 'git log --oneline --graph --date=short --color=always --pretty="format:%C(auto)%cd %h%d %s" $(sed s/^..// <<< {} | cut -d" " -f1)' "$@" |
    sed 's/^..//' | cut -d' ' -f1 | pbcopy
}


#----------------------------------------------------------------------------------
# Shows git branches and switch it
#----------------------------------------------------------------------------------
function gswitch() {
  if ! git ls-files >& /dev/null; then
    echo $'Git project not found\n'
    return ;
  fi
  currentBranch=("Current branch:" $(git branch 2> /dev/null | sed -n -e 's/^\* \(.*\)/[\1]/p'))
  _git_check || return
  bash "$__fzf_git" bswitch |
  fzf -e --ansi \
    --prompt ' Search branch to switch: ' \
    --header "$currentBranch " \
    --header-lines 2 \
    --preview-window down,border-top,40% \
    --tiebreak begin \
    --color hl:underline,hl+:underline \
    --layout reverse \
    --border \
    --bind "alt-a:change-prompt( All branches> )+reload:bash \"$__fzf_git\" all-branches" |
    xargs git switch; git pull
}


#----------------------------------------------------------------------------------
# Shows git tags
#----------------------------------------------------------------------------------
function gtag() {
  if ! git ls-files >& /dev/null; then
    echo $'Git project not found\n'
    return ;
  fi
  _git_check || return
  git tag --sort -version:refname |
  fzf -m -e --ansi \
    --prompt ' Search tag: ' \
    --header $'ESC (exit)\n\n' \
    --preview-window right,70% \
    --tiebreak begin \
    --color hl:underline,hl+:underline \
    --layout reverse \
    --border \
    --preview 'git show --color=always {}' "$@" | pbcopy
}


#----------------------------------------------------------------------------------
# Shows git stashes
#----------------------------------------------------------------------------------
function gstash() {
  if ! git ls-files >& /dev/null; then
    echo $'Git project not found\n'
    return ;
  fi
  _git_check || return
  git stash list | \
  fzf -m -e --ansi -d: \
    --prompt ' Search stash: ' \
    --header $'ESC (exit) ╱ CTRL-X (drop stash)\n\n' \
    --preview-window right,70% \
    --tiebreak begin \
    --color hl:underline,hl+:underline \
    --layout reverse \
    --border \
    --bind 'ctrl-x:execute-silent(git stash drop {1})+reload(git stash list)' \
    --preview 'git show --color=always {1}' "$@" | cut -d: -f1
}


#----------------------------------------------------------------------------------
# Shows git status
#----------------------------------------------------------------------------------
function gstatus() {
  if ! git ls-files >& /dev/null; then
    echo $'Git project not found\n'
    return ;
  fi
  git status -s | awk '{print $2 " " $1}'| \
  fzf -m -e --ansi \
    --prompt ' Search file: ' \
    --header $'ESC (exit) ╱ CTRL-J (down) ╱ CTRL-K (up) \n\n' \
    --preview-window right,70% \
    --tiebreak begin \
    --color hl:underline,hl+:underline \
    --layout reverse \
    --border \
    --bind=ctrl-j:preview-down \
    --bind=ctrl-k:preview-up \
    --preview 'git diff --color=always {+1}' | xargs nvim -p
}


#----------------------------------------------------------------------------------
# Gets the name of the parent branch
#----------------------------------------------------------------------------------
function gparent() {
  if ! git ls-files >& /dev/null; then
    echo $'Git project not found\n'
    return ;
  fi
  git show-branch \
  | grep '\*' \
  | grep -v `git rev-parse --abbrev-ref HEAD` \
  | head -n1 \
  | sed 's/.*\[\(.*\)\].*/\1/' \
  | sed 's/[\^~].*//'
}


#----------------------------------------------------------------------------------
# Finds files inside of the current path
#----------------------------------------------------------------------------------
function ff() {
  find . -type f \
    -not -path "*/node_modules/*" \
    -not -path "*/target/*" \
    -not -path "*/.zsh_sessions/*" \
    -not -path "*/.npm-global/*" \
    -not -path "*/.node*/*" \
    -not -path "*/build/*" \
    | fzf -m -e --ansi \
    --prompt ' Search file: ' \
    --header $'Press <ENTER> to edit / <ESC> to exit.\n\n' \
    --preview-window right,60% \
    --bind='ctrl-space:toggle-preview' \
    --tiebreak begin \
    --color hl:underline,hl+:underline \
    --layout reverse \
    --border \
    --preview '[[ $(file --mime {}) =~ binary ]] && echo {} is a binary file ||
        (bat --style=numbers --color=always {} || highlight -O ansi -l {} ||
        coderay {} || rougify {} || cat {}) 2> /dev/null | head -500' | xargs nvim -p

}

#----------------------------------------------------------------------------------
# Finds folders inside of the current path
#----------------------------------------------------------------------------------
function fd() {
  cmd="command find -L . -mindepth 1 \
  \\( -path '*/\\.*' -o -fstype 'sysfs' -o -fstype 'devfs' -o -fstype 'devtmpfs' \
  -o -fstype 'proc' -o -name 'node_modules' -o -name 'build' -o -name 'Library' \
  -o -name '*.photoslibrary' -o -name 'classes' -o -name 'target' \\) \
  -prune -o -type d -print 2> /dev/null | cut -b3-"

    cd $(eval "$cmd" | \
      fzf -e --ansi \
        --prompt ' Search folder: ' \
        --header $'ESC (exit)\n\n' \
        --layout reverse \
        --border)
}
